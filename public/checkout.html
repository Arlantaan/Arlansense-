<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout - Sensation by Sanu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body.hero {
      min-height: 100vh;
      background-image: url('images/2151839595.jpg');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      color: white;
    }
    .checkout-content {
      position: relative;
      z-index: 1;
      margin-top: 40px;
    }
  </style>
</head>
<body class="hero">
  <div class="checkout-content container">
    <h2 class="text-center mb-4">Checkout</h2>
    <div class="row justify-content-center">
      <div class="col-lg-7">
        <div class="card p-4 mb-4">
          <h5>Order Summary</h5>
          <div id="orderSummary"></div>
          <hr>
          <form id="checkoutForm">
            <div class="mb-3">
              <label for="name" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="name" required />
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" required />
            </div>
            <div class="mb-3">
              <label for="phone" class="form-label">Phone</label>
              <input type="tel" class="form-control" id="phone" required />
            </div>
            <div class="mb-3">
              <label for="address" class="form-label">Delivery Address</label>
              <textarea class="form-control" id="address" rows="2" required></textarea>
            </div>
            <div id="checkoutMsg" class="text-danger small mb-2"></div>
            <div class="text-end">
              <button type="submit" class="btn btn-dark btn-lg">Place Order</button>
            </div>
          </form>
        </div>
        <div class="text-center">
          <a href="cart.html" class="btn btn-outline-secondary">Back to Cart</a>
        </div>
      </div>
    </div>
  </div>
  <!-- Payment Integration -->
  <div id="payment-element" class="mb-3"></div>
  <div id="payment-error" class="alert alert-danger" style="display: none;"></div>
  
  <!-- Loading Spinner -->
  <div id="payment-loader" class="text-center" style="display: none;">
    <div class="spinner-border text-warning" role="status">
      <span class="visually-hidden">Processing payment...</span>
    </div>
    <p class="mt-2">Processing your payment...</p>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script src="js/config.js"></script>
  <script src="js/cart.js"></script>
  <script src="js/payment.js"></script>
  <script src="js/analytics.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    // Initialize Firebase with config
    const app = initializeApp(CONFIG.firebase);
    const db = getFirestore(app);

    // Initialize payment system
    const paymentSystem = new PaymentSystem();
    let paymentInitialized = false;

    // Get cart from enhanced cart manager
    const cart = cartManager.getCart();
    const subtotal = cartManager.getTotal();

    const orderSummary = document.getElementById('orderSummary');
    if (cartManager.isEmpty()) {
      orderSummary.innerHTML = '<div class="alert alert-warning">Your cart is empty.</div>';
      document.getElementById('checkoutForm').style.display = 'none';
    } else {
      orderSummary.innerHTML = cart.map(item => `
        <div class="d-flex align-items-center mb-2">
          <img src="${item.image || 'images/fallback.png'}" alt="${item.name}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;margin-right:10px;" onerror="this.src='images/fallback.png'">
          <div class="flex-grow-1">
            <strong>${item.name}</strong> <span class="text-muted">x${item.quantity}</span><br>
            <span class="text-secondary">D${item.price.toLocaleString()}</span>
          </div>
          <div class="fw-bold">D${(item.price * item.quantity).toLocaleString()}</div>
        </div>
      `).join('') + `<hr><div class="text-end fw-bold">Subtotal: D${subtotal.toLocaleString()}</div>`;
      
      // Initialize payment after order summary is displayed
      initializePayment();
    }

    // Initialize payment system
    async function initializePayment() {
      try {
        PaymentUI.hideError();
        await paymentSystem.initializePayment(subtotal, 'gmd');
        paymentInitialized = true;
      } catch (error) {
        console.error('Payment initialization failed:', error);
        PaymentUI.showError('Payment system unavailable. Please contact support.');
      }
    }

    // Enhanced form validation
    function validateForm() {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();

      if (!name || name.length < 2) {
        throw new Error('Please enter a valid name (minimum 2 characters)');
      }

      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        throw new Error('Please enter a valid email address');
      }

      if (!phone || phone.length < 10) {
        throw new Error('Please enter a valid phone number');
      }

      if (!address || address.length < 10) {
        throw new Error('Please enter a complete delivery address');
      }

      return { name, email, phone, address };
    }

    // Enhanced order processing
    const checkoutForm = document.getElementById('checkoutForm');
    const checkoutMsg = document.getElementById('checkoutMsg');
    
    checkoutForm && checkoutForm.addEventListener('submit', async e => {
      e.preventDefault();
      
      try {
        // Validate form
        const formData = validateForm();
        
        // Show loading state
        PaymentUI.showLoading();
        PaymentUI.hideError();

        // Process payment first
        if (paymentInitialized) {
          const paymentResult = await paymentSystem.processPayment();
          if (!paymentResult.success) {
            throw new Error('Payment failed. Please try again.');
          }
        }

        // Create order data
        const orderData = {
          name: formData.name,
          email: formData.email,
          phone: formData.phone,
          address: formData.address,
          cart: cart.map(item => ({ 
            name: item.name, 
            price: item.price, 
            quantity: item.quantity,
            image: item.image 
          })),
          subtotal: subtotal,
          status: 'pending',
          paymentStatus: paymentInitialized ? 'paid' : 'pending',
          createdAt: new Date(),
          customerId: window.analytics ? window.analytics.userId : null
        };

        // Save order to Firebase
        const docRef = await addDoc(collection(db, 'orders'), orderData);
        
        // Clear cart
        cartManager.clearCart();
        
        // Track purchase
        if (window.analytics) {
          window.analytics.trackPurchase({
            orderId: docRef.id,
            subtotal: subtotal,
            cart: cart
          });
        }

        // Show success message
        PaymentUI.hideLoading();
        checkoutMsg.innerHTML = '<span class="text-success">Thank you! Your order has been placed successfully.</span>';
        
        // Redirect to success page
        setTimeout(() => {
          window.location.href = `payment-success.html?order=${docRef.id}`;
        }, 1500);
        
      } catch (error) {
        console.error('Error placing order:', error);
        PaymentUI.hideLoading();
        PaymentUI.showError(error.message || 'Error placing order. Please try again.');
        checkoutMsg.innerHTML = `<span class="text-danger">${error.message || 'Order failed. Please try again.'}</span>`;
      }
    });
  </script>
</body>
</html>
